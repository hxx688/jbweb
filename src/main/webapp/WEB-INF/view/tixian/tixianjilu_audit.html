<!-- 
 * Generated by Blade.
 * 2017-01-09 15:38:46
 -->
@layout("/common/_container.html"){

	<form data-url="${ctxPath}/${code}/audit" method="post" class="form-horizontal" role="form">
	
		<!-- 表单 -->
		@ var _table="dt_tixianjilu";
		@ var _key="id";
		@ var _col=[
		@			  {name:"订单号", index:"tixianNum", type:"span", newline:true, length:8},
		@			  {name:"会员账号", index:"user_name", type:"span", newline:true, length:8},
		@			  {name:"开户行", index:"kaihuhang", type:"span", newline:true, length:8},
		@			  {name:"开户名", index:"kaihuming", type:"span", newline:true, length:8},
		@			  {name:"卡号", index:"kahao", type:"span", newline:true, length:8},
		@			  {name:"省", index:"sheng", type:"span", newline:true, length:8},
		@			  {name:"市", index:"shi", type:"span", newline:true, length:8},
		@			  {name:"支行", index:"zhihang", type:"span", newline:true, length:8},
		@			  {name:"订单状态", index:"status_name", type:"span", newline:true, length:8},
		@			  {name:"提现金额", index:"shijiamount", type:"span", newline:true, length:8},
		@			  {name:"手续费", index:"shouxufei", type:"span", newline:true, length:8},
		@			  {name:"到账金额", index:"amount", type:"span", newline:true, length:8},
		@			  {name:"操作时间", index:"add_time", type:"span", newline:true, length:8}
		@		   ];
		@ include("/common/_curd/_edit.html", {"col":_col, "table":_table, "key":_key}){}
		
		
<!-- 
		<div class="form-group" style="display:block">
			<label class="col-sm-2 control-label no-padding-right">转账凭证</label>			
			<div class="col-sm-8">
				<blade:imgupload id="file_id" name="dt_tixianjilu.file_id" auto="" />
			</div>
		</div>
		               -->          	
		<input type="hidden" id="status" name="dt_tixianjilu.status" class="form-control" value=""/>
		<div class="form-group" style="display:block">
			<label class="col-sm-2 control-label no-padding-right">原因 </label>			
			<div class="col-sm-8">
				<input type="text" id="yuanyin" name="dt_tixianjilu.yuanyin" value="${dt_tixianjilu.yuanyin!}" class="form-control" />
			</div>
		</div>
		
		<!-- 按钮 -->
		<div class="clearfix form-actions center" style="margin-top:15px;margin-bottom:5px;">
			<div class="col-md-offset-1 col-md-10">
			  	<button class="btn btn-info" type="submit" id="btn_save">
					<i class="ace-icon fa fa-check bigger-110"></i>
					手动付款
				</button>
				&nbsp; &nbsp; &nbsp;
				<button class="btn btn-backs" type="button" id="btn_pay">
					<i class="ace-icon fa fa-check bigger-110"></i>
					自动付款
				</button>
				&nbsp; &nbsp; &nbsp;
				<button class="btn btn-backs" type="button" id="btn_back">
					<i class="ace-icon fa fa-close bigger-110"></i>
					退回
				</button>
				&nbsp; &nbsp; &nbsp;
				<button class="btn" type="button" id="btn_close">
					<i class="ace-icon fa fa-close bigger-110"></i>
					关闭
				</button>
			</div>
		</div>
		<script src="${ctxPath}/static/validate/jquery-html5Validate.js"></script>
		<script src="${ctxPath}/static/lfgj/tools.js"></script>
		
		<script type="text/javascript">
			var layerIndex = parent.layer.getFrameIndex(window.name); //获取窗口索引
			
			$(function(){
				$("form").html5Validate(function() {
					var $form = $(this);
					layer.confirm('确定要审核吗？', {
		                icon: 3,
		                btn: ['确定', '取消'] //按钮
		            }, function () {
		            	$("#status").val("2");
		            	if( typeof saveBefore === 'function' ){
							saveBefore();
				        }
		            	$("#btn_save").attr("disabled","disabled");
						$("#btn_back").attr("disabled","disabled");
						$("#btn_pay").attr("disabled","disabled");
						var appindex = appLoading();
						
						var ajax = new $ax($form.attr("data-url"), function(data){
							if (data.code === 0) {
								clearLoading(appindex);
								layer.msg(data.message, {shift: 1});
								setTimeout(function(){
									closeTab(true);
								},500);
								return false;
							} else {
								clearLoading(appindex);
								$("#btn_save").attr("disabled","disabled");
								$("#btn_back").attr("disabled","disabled");
								$("#btn_pay").attr("disabled","disabled");
								if(data.code===999){
									layer.alert(data.message, {icon: 2,title:"发生错误"});
								}
								else{
									layer.msg(data.message, {shift: 6,time:2000});
								}
								return false;
							}
						});
						ajax.data = $form.serialize();
						ajax.start();
						
						return false;
		            }, function () {
		                //layer.msg('已取消');
		            });
					
				}, {
					// novalidate: false
				});
				
				$("#btn_back").bind("click",function(){
					var remark = $("#yuanyin").val();
					if(remark == ''){
						layer.alert("请填写退回原因");
						return;
					}
					var $form = $("form");
					layer.confirm('确定要退回吗？', {
		                icon: 3,
		                btn: ['确定', '取消'] //按钮
		            }, function () {
		            	$("#status").val("3");
		            	if( typeof saveBefore === 'function' ){
							saveBefore();
				        }
						$("#btn_save").attr("disabled","disabled");
						$("#btn_back").attr("disabled","disabled");
						$("#btn_pay").attr("disabled","disabled");
						var appindex = appLoading();
						var ajax = new $ax($form.attr("data-url"), function(data){
							if (data.code === 0) {
								clearLoading(appindex);
								layer.msg(data.message, {shift: 1});
								setTimeout(function(){
									closeTab(true);
								},500);
								return false;
							} else {
								clearLoading(appindex);
								$("#btn_save").removeAttr("disabled","disabled");
								$("#btn_back").removeAttr("disabled","disabled");
								$("#btn_pay").removeAttr("disabled","disabled");
								if(data.code===999){
									layer.alert(data.message, {icon: 2,title:"发生错误"});
								}
								else{
									layer.msg(data.message, {shift: 6,time:2000});
								}
								return false;
							}
						});
						ajax.data = $form.serialize();
						ajax.start();
						
						return false;
		            }, function () {
		                //layer.msg('已取消');
		            });
				});
				
				$("#btn_pay").bind("click",function(){
					
					var $form = $("form");
					layer.confirm('确定通过并付款吗？', {
		                icon: 3,
		                btn: ['确定', '取消'] //按钮
		            }, function () {
		            	$("#status").val("5");
		            	if( typeof saveBefore === 'function' ){
							saveBefore();
				        }
						$("#btn_save").attr("disabled","disabled");
						$("#btn_back").attr("disabled","disabled");
						$("#btn_pay").attr("disabled","disabled");
						var appindex = appLoading();
						var ajax = new $ax($form.attr("data-url"), function(data){
							if (data.code === 0) {
								clearLoading(appindex);
								layer.msg(data.message, {shift: 1});
								setTimeout(function(){
									closeTab(true);
								},500);
								return false;
							} else {
								clearLoading(appindex);
								$("#btn_save").removeAttr("disabled","disabled");
								$("#btn_back").removeAttr("disabled","disabled");
								$("#btn_pay").removeAttr("disabled","disabled");
								if(data.code===999){
									layer.alert(data.message, {icon: 2,title:"发生错误"});
								}
								else{
									layer.msg(data.message, {shift: 6,time:2000});
								}
								return false;
							}
						});
						ajax.data = $form.serialize();
						ajax.start();
						
						return false;
		            }, function () {
		                //layer.msg('已取消');
		            });
				});
				
				$("#btn_close").bind("click",function(){
					closeTab(("${auto_close!}" == "true") ? true : false);
				});
				
				function closeTab(isReload){
					//未找到layerIndex代表为新增tab页
					if(typeof (layerIndex) == "undefined"){
						var tabId = "";
						var dataUrl = $("form").attr("data-url");
						if(typeof (dataUrl) == "undefined"){
							tabId = "btn_${code}_view_${id!}";
						}else if(dataUrl.indexOf("save") > 0){
							tabId = "btn_${code}_add";
						}else if(dataUrl.indexOf("update") > 0){
							tabId = "btn_${code}_edit_${id!}";
						}else{
							tabId = "btn_${code}_view_${id!}";
						}
						if(isReload){
							window.top.reloadTabById("${code!}")
						}
						window.top.autoClose(tabId,"${code!}");
					} else{
						if(isReload){
							parent.searchGrid();
						}
						parent.layer.close(layerIndex);
					}
				}
				
			});
		</script>
	</form>

@}